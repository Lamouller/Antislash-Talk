#!/bin/bash
# ============================================
# Script de d√©ploiement complet Antislash Talk
# ============================================
# Ce script initialise tout automatiquement :
# - G√©n√©ration des cl√©s JWT
# - Configuration des fichiers .env
# - D√©ploiement de tous les services
# - Application des migrations
# - Configuration des permissions

set -e  # Arr√™ter en cas d'erreur

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë     üöÄ D√âPLOIEMENT COMPLET ANTISLASH TALK - MONOREPO         ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

# ============================================
# 1. G√âN√âRATION DES CL√âS JWT
# ============================================
echo "1Ô∏è‚É£  G√©n√©ration des cl√©s JWT s√©curis√©es..."
echo ""

if [ ! -f .env ] || ! grep -q "^JWT_SECRET=" .env 2>/dev/null; then
    echo "   ‚Üí G√©n√©ration de nouvelles cl√©s JWT..."
    
    python3 << 'PYTHON_SCRIPT'
import secrets
import json
import base64
import hmac
import hashlib
from datetime import datetime, timedelta

# G√©n√©rer un secret JWT fort (32 bytes = 256 bits)
jwt_secret_bytes = secrets.token_bytes(32)
jwt_secret = base64.urlsafe_b64encode(jwt_secret_bytes).decode('utf-8').rstrip('=')

print(f"   ‚úÖ JWT_SECRET g√©n√©r√©")

# Fonction pour cr√©er un JWT
def create_jwt(payload, secret):
    # Header
    header = {'alg': 'HS256', 'typ': 'JWT'}
    header_b64 = base64.urlsafe_b64encode(json.dumps(header, separators=(',', ':')).encode()).decode().rstrip('=')
    
    # Payload
    payload_b64 = base64.urlsafe_b64encode(json.dumps(payload, separators=(',', ':')).encode()).decode().rstrip('=')
    
    # Signature
    message = f'{header_b64}.{payload_b64}'
    signature = hmac.new(secret.encode(), message.encode(), hashlib.sha256).digest()
    signature_b64 = base64.urlsafe_b64encode(signature).decode().rstrip('=')
    
    return f'{header_b64}.{payload_b64}.{signature_b64}'

# Timestamps
now = int(datetime.now().timestamp())
exp = int((datetime.now() + timedelta(days=3650)).timestamp())

# Cr√©er les JWT
anon_key = create_jwt({
    'iss': 'supabase',
    'role': 'anon',
    'iat': now,
    'exp': exp
}, jwt_secret)

service_role_key = create_jwt({
    'iss': 'supabase',
    'role': 'service_role',
    'iat': now,
    'exp': exp
}, jwt_secret)

# Sauvegarder dans .env
with open('.env', 'w') as f:
    f.write('# ============================================\n')
    f.write('# Antislash Talk - Configuration Monorepo\n')
    f.write('# G√©n√©r√© automatiquement\n')
    f.write('# ============================================\n\n')
    f.write('# Database\n')
    f.write('POSTGRES_DB=postgres\n')
    f.write('POSTGRES_PORT=5432\n')
    f.write('POSTGRES_PASSWORD=your-super-secret-and-long-postgres-password\n\n')
    f.write('# JWT Configuration\n')
    f.write(f'JWT_SECRET={jwt_secret}\n')
    f.write(f'ANON_KEY={anon_key}\n')
    f.write(f'SERVICE_ROLE_KEY={service_role_key}\n')
    f.write('JWT_EXPIRY=3600\n\n')
    f.write('# URLs\n')
    f.write('SITE_URL=http://localhost:3000\n')
    f.write('API_EXTERNAL_URL=http://localhost:54321\n')
    f.write('SUPABASE_PUBLIC_URL=http://localhost:54321\n\n')
    f.write('# Service Ports\n')
    f.write('KONG_HTTP_PORT=54321\n')
    f.write('STUDIO_PORT=54323\n')
    f.write('WEB_PORT=3000\n\n')
    f.write('# Email Configuration\n')
    f.write('ENABLE_EMAIL_SIGNUP=true\n')
    f.write('ENABLE_EMAIL_AUTOCONFIRM=true\n')
    f.write('SMTP_ADMIN_EMAIL=admin@antislash-talk.local\n')
    f.write('SMTP_HOST=inbucket\n')
    f.write('SMTP_PORT=2500\n')
    f.write('SMTP_SENDER_NAME=Antislash Talk\n')

print("   ‚úÖ ANON_KEY g√©n√©r√©")
print("   ‚úÖ SERVICE_ROLE_KEY g√©n√©r√©")
print("   ‚úÖ Fichier .env cr√©√©")
PYTHON_SCRIPT

    # Copier aussi pour .env.monorepo
    cp .env .env.monorepo
    echo "   ‚úÖ Fichier .env.monorepo cr√©√©"
else
    echo "   ‚úÖ Cl√©s JWT d√©j√† pr√©sentes dans .env"
fi

echo ""

# ============================================
# 2. MISE √Ä JOUR DE KONG.YML AVEC LES VRAIES CL√âS
# ============================================
echo "2Ô∏è‚É£  Configuration de Kong avec les cl√©s JWT..."
echo ""

ANON_KEY=$(grep "^ANON_KEY=" .env | cut -d'=' -f2)
SERVICE_KEY=$(grep "^SERVICE_ROLE_KEY=" .env | cut -d'=' -f2)

# Mettre √† jour kong.yml avec les vraies cl√©s
sed -i.bak "s|key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.*anon.*|key: $ANON_KEY|g" packages/supabase/kong.yml
sed -i.bak "s|key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.*service_role.*|key: $SERVICE_KEY|g" packages/supabase/kong.yml

echo "   ‚úÖ Kong configur√© avec les cl√©s JWT"
echo ""

# ============================================
# 3. ARR√äT DES CONTENEURS EXISTANTS
# ============================================
echo "3Ô∏è‚É£  Arr√™t des conteneurs existants (si pr√©sents)..."
echo ""

docker-compose -f docker-compose.monorepo.yml down 2>/dev/null || true
echo "   ‚úÖ Conteneurs arr√™t√©s"
echo ""

# ============================================
# 4. D√âMARRAGE DE TOUS LES SERVICES
# ============================================
echo "4Ô∏è‚É£  D√©marrage de tous les services..."
echo ""

docker-compose -f docker-compose.monorepo.yml up -d

echo ""
echo "   ‚è≥ Attente du d√©marrage de la base de donn√©es (30 secondes)..."
sleep 30

# V√©rifier que la DB est pr√™te
until docker exec antislash-talk-db pg_isready -U postgres -d postgres > /dev/null 2>&1; do
  echo "   ‚è≥ Attente de PostgreSQL..."
  sleep 2
done

echo "   ‚úÖ PostgreSQL est pr√™t"
echo ""

# ============================================
# 5. APPLICATION DES PERMISSIONS
# ============================================
echo "5Ô∏è‚É£  Configuration des permissions PostgreSQL..."
echo ""

docker exec antislash-talk-db psql -U postgres -d postgres << 'SQL'
-- Permissions pour supabase_admin (utilis√© par Meta/Studio)
GRANT USAGE ON SCHEMA auth TO supabase_admin;
GRANT USAGE ON SCHEMA public TO supabase_admin;
GRANT USAGE ON SCHEMA storage TO supabase_admin;

GRANT SELECT ON ALL TABLES IN SCHEMA auth TO supabase_admin;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO supabase_admin;
GRANT SELECT ON ALL TABLES IN SCHEMA storage TO supabase_admin;

ALTER DEFAULT PRIVILEGES IN SCHEMA auth GRANT SELECT ON TABLES TO supabase_admin;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO supabase_admin;
ALTER DEFAULT PRIVILEGES IN SCHEMA storage GRANT SELECT ON TABLES TO supabase_admin;

-- Permissions pour postgres (SQL Editor)
GRANT USAGE ON SCHEMA auth TO postgres;
GRANT SELECT ON ALL TABLES IN SCHEMA auth TO postgres;

SELECT 'Permissions configur√©es' as status;
SQL

echo "   ‚úÖ Permissions PostgreSQL configur√©es"
echo ""

# ============================================
# 6. APPLICATION DES MIGRATIONS
# ============================================
echo "6Ô∏è‚É£  Application des migrations de la base de donn√©es..."
echo ""

if [ -f "packages/supabase/apply-migrations.sh" ]; then
    bash packages/supabase/apply-migrations.sh
else
    echo "   ‚ö†Ô∏è  Script apply-migrations.sh non trouv√©, cr√©ation..."
    
    cat > packages/supabase/apply-migrations.sh << 'MIGRATIONS_SCRIPT'
#!/bin/bash
set -e

echo "   üîÑ Application des migrations Supabase..."

# Attendre que la base de donn√©es soit pr√™te
until docker exec antislash-talk-db pg_isready -U postgres -d postgres > /dev/null 2>&1; do
  sleep 1
done

# Appliquer les migrations
MIGRATION_DIR="./packages/supabase/migrations"
for migration_file in $(ls $MIGRATION_DIR/*.sql 2>/dev/null | sort); do
  MIGRATION_NAME=$(basename "$migration_file")
  
  # V√©rifier si la migration a d√©j√† √©t√© appliqu√©e
  if docker exec antislash-talk-db psql -U postgres -d postgres -tAc "SELECT 1 FROM public.schema_migrations WHERE version = '$MIGRATION_NAME'" 2>/dev/null | grep -q 1; then
    echo "      ‚Üí Skipping: $MIGRATION_NAME (d√©j√† appliqu√©e)"
  else
    echo "      ‚Üí Applying: $MIGRATION_NAME"
    docker exec -i antislash-talk-db psql -U postgres -d postgres < "$migration_file"
    docker exec antislash-talk-db psql -U postgres -d postgres -c "INSERT INTO public.schema_migrations (version) VALUES ('$MIGRATION_NAME')" 2>/dev/null || true
    echo "        ‚úÖ Appliqu√©e avec succ√®s"
  fi
done

echo "   ‚úÖ Migrations termin√©es !"
MIGRATIONS_SCRIPT

    chmod +x packages/supabase/apply-migrations.sh
    bash packages/supabase/apply-migrations.sh
fi

echo ""

# ============================================
# 7. RED√âMARRAGE DES SERVICES POUR APPLIQUER LES CHANGEMENTS
# ============================================
echo "7Ô∏è‚É£  Red√©marrage des services Meta et Studio..."
echo ""

docker-compose -f docker-compose.monorepo.yml restart meta studio kong
sleep 5

echo "   ‚úÖ Services red√©marr√©s"
echo ""

# ============================================
# 8. V√âRIFICATION FINALE
# ============================================
echo "8Ô∏è‚É£  V√©rification de l'√©tat du syst√®me..."
echo ""

# Compter les services actifs
RUNNING_SERVICES=$(docker-compose -f docker-compose.monorepo.yml ps --services --filter "status=running" | wc -l)
echo "   ‚úÖ $RUNNING_SERVICES services en cours d'ex√©cution"

# V√©rifier la DB
USER_COUNT=$(docker exec antislash-talk-db psql -U postgres -d postgres -tAc "SELECT COUNT(*) FROM auth.users" 2>/dev/null || echo "0")
echo "   ‚úÖ $USER_COUNT utilisateur(s) dans la base"

# V√©rifier les migrations
MIGRATION_COUNT=$(docker exec antislash-talk-db psql -U postgres -d postgres -tAc "SELECT COUNT(*) FROM public.schema_migrations" 2>/dev/null || echo "0")
echo "   ‚úÖ $MIGRATION_COUNT migration(s) appliqu√©e(s)"

echo ""

# ============================================
# 9. R√âSUM√â ET ACC√àS
# ============================================
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë        ‚úÖ D√âPLOIEMENT TERMIN√â AVEC SUCC√àS ! ‚úÖ                ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""
echo "üåê ACC√àS AUX SERVICES:"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "   ‚Ä¢ Application Web:     http://localhost:3000"
echo "   ‚Ä¢ Supabase Studio:     http://localhost:54323"
echo "   ‚Ä¢ API Gateway (Kong):  http://localhost:54321"
echo "   ‚Ä¢ PostgreSQL:          localhost:5432"
echo "   ‚Ä¢ Inbucket (Email):    http://localhost:54324"
echo ""
echo "üìã SERVICES OPTIONNELS:"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "   Pour d√©marrer Ollama:"
echo "   ‚Üí Services inclus dans docker-compose, d√©j√† d√©marr√©s"
echo ""
echo "   Pour d√©marrer PyTorch Transcription:"
echo "   ‚Üí docker-compose -f docker-compose.monorepo.yml --profile pytorch up -d"
echo ""
echo "üîê CONFIGURATION:"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "   ‚Ä¢ Fichier .env cr√©√© avec cl√©s JWT s√©curis√©es"
echo "   ‚Ä¢ Kong configur√© automatiquement"
echo "   ‚Ä¢ Migrations appliqu√©es"
echo "   ‚Ä¢ Permissions configur√©es"
echo ""
echo "üìñ PROCHAINES √âTAPES:"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "   1. Cr√©er votre premier utilisateur dans Studio"
echo "   2. Ou utiliser l'API signup: http://localhost:54321/auth/v1/signup"
echo "   3. D√©velopper votre application !"
echo ""
echo "üí° COMMANDES UTILES:"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "   ‚Ä¢ Voir les logs:    docker-compose -f docker-compose.monorepo.yml logs -f"
echo "   ‚Ä¢ Arr√™ter tout:     docker-compose -f docker-compose.monorepo.yml down"
echo "   ‚Ä¢ Red√©marrer:       docker-compose -f docker-compose.monorepo.yml restart"
echo "   ‚Ä¢ Red√©ployer:       ./deploy-complete.sh"
echo ""
echo "‚úÖ Votre syst√®me Antislash Talk est maintenant pr√™t ! üöÄ"
echo ""


